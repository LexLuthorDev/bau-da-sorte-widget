class BauDaSorteWidget{constructor(e={}){this.options={containerId:e.containerId||"bau-da-sorte-widget",apiUrl:e.apiUrl||"http://localhost:3001",apiKey:e.apiKey||"example-api-key-123",playerId:e.playerId||null,playerBalance:e.playerBalance||1e3,playerUsername:e.playerUsername||null,playerEmail:e.playerEmail||null,onPlayerLogin:e.onPlayerLogin||null,onChestOpened:e.onChestOpened||null,onBalanceUpdate:e.onBalanceUpdate||null,onError:e.onError||null,autoCloseDelay:e.autoCloseDelay||5e3,...e},this.autoCloseTimer=null,this.player=null,this.playerToken=null,this.chestTypes=[],this.currentState="closed",this.isAnimating=!1,this.currentPrize=null,this.currentChestType="classico",this.chest=null,this.chestSprite=null,this.prizeContainer=null,this.prize=null,this.prizeImage=null,this.prizeValue=null,this.openBtn=null,this.closeBtn=null,this.balanceAmount=null,this.backBtn=null,this.sprites={classico:{closed:"baus/bau_fechado_classico.png",open:"baus/bau_aberto_classico.png",openGlow:"baus/bau_abereto_brilho_classico.png"},diamante:{closed:"baus/bau_fechado_diamante.png",open:"baus/bau_aberto_diamante.png",openGlow:"baus/bau_aberto_brilho_diamante.png"},esmeralda:{closed:"baus/bau_fechado_esmeralda.png",open:"baus/bau_aberto_esmeralda.png",openGlow:"baus/bau_aberto_brilho_esmeralda.png"},premium:{closed:"baus/bau_fechado_classico.png",open:"baus/bau_aberto_classico.png",openGlow:"baus/bau_abereto_brilho_classico.png"},vip:{closed:"baus/bau_fechado_diamante.png",open:"baus/bau_aberto_diamante.png",openGlow:"baus/bau_aberto_brilho_diamante.png"}},this.soundEffects=new SoundEffects,this.init()}async init(){try{if(this.container=document.getElementById(this.options.containerId),!this.container)throw new Error(`Container com ID '${this.options.containerId}' não encontrado`);await this.validateApiKey(),this.render(),this.validateElements(),this.attachEventListeners(),await this.loadChestTypes(),this.updateBackground("classico"),this.options.playerId&&await this.initializePlayer(),this.updateButtons()}catch(e){this.handleError("Erro ao inicializar widget",e)}}render(){this.container.innerHTML='\n      <style>\n      * {\n        margin: 0;\n        padding: 0;\n        box-sizing: border-box;\n      }\n\n      body {\n        font-family: \'Arial\', sans-serif;\n        min-height: 100vh;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        color: white;\n        padding: 10px;\n        box-sizing: border-box;\n        position: relative;\n        overflow-x: hidden;\n        transition: all 0.8s ease;\n      }\n\n      /* Background Clássico (padrão) */\n      body.chest-classico {\n        background: \n          radial-gradient(circle at 20% 20%, rgba(139, 69, 19, 0.3) 0%, transparent 50%),\n          radial-gradient(circle at 80% 80%, rgba(160, 82, 45, 0.2) 0%, transparent 50%),\n          radial-gradient(circle at 40% 60%, rgba(205, 133, 63, 0.1) 0%, transparent 50%),\n          linear-gradient(135deg, #2c1810 0%, #1a0f0a 50%, #0d0704 100%) !important;\n      }\n\n      /* Background Diamante */\n      body.chest-diamante {\n        background: \n          radial-gradient(circle at 20% 20%, rgba(70, 130, 180, 0.3) 0%, transparent 50%),\n          radial-gradient(circle at 80% 80%, rgba(100, 149, 237, 0.2) 0%, transparent 50%),\n          radial-gradient(circle at 40% 60%, rgba(135, 206, 250, 0.1) 0%, transparent 50%),\n          linear-gradient(135deg, #0f1419 0%, #0a0f14 50%, #05080a 100%) !important;\n      }\n\n      /* Background Esmeralda */\n      body.chest-esmeralda {\n        background: \n          radial-gradient(circle at 20% 20%, rgba(34, 139, 34, 0.3) 0%, transparent 50%),\n          radial-gradient(circle at 80% 80%, rgba(50, 205, 50, 0.2) 0%, transparent 50%),\n          radial-gradient(circle at 40% 60%, rgba(144, 238, 144, 0.1) 0%, transparent 50%),\n          linear-gradient(135deg, #0f1a0f 0%, #0a140a 50%, #050a05 100%) !important;\n      }\n\n\n      /* Efeito de partículas de fundo - Clássico */\n      body.chest-classico::before {\n        content: \'\';\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: \n          radial-gradient(2px 2px at 20px 30px, rgba(255, 215, 0, 0.3), transparent),\n          radial-gradient(2px 2px at 40px 70px, rgba(255, 215, 0, 0.2), transparent),\n          radial-gradient(1px 1px at 90px 40px, rgba(255, 215, 0, 0.4), transparent),\n          radial-gradient(1px 1px at 130px 80px, rgba(255, 215, 0, 0.3), transparent),\n          radial-gradient(2px 2px at 160px 30px, rgba(255, 215, 0, 0.2), transparent);\n        background-repeat: repeat;\n        background-size: 200px 100px;\n        animation: sparkle 20s linear infinite;\n        z-index: -1;\n        opacity: 0.6;\n        pointer-events: none;\n      }\n\n      /* Efeito de partículas de fundo - Diamante */\n      body.chest-diamante::before {\n        content: \'\';\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: \n          radial-gradient(2px 2px at 20px 30px, rgba(135, 206, 250, 0.4), transparent),\n          radial-gradient(2px 2px at 40px 70px, rgba(100, 149, 237, 0.3), transparent),\n          radial-gradient(1px 1px at 90px 40px, rgba(70, 130, 180, 0.5), transparent),\n          radial-gradient(1px 1px at 130px 80px, rgba(135, 206, 250, 0.4), transparent),\n          radial-gradient(2px 2px at 160px 30px, rgba(100, 149, 237, 0.3), transparent);\n        background-repeat: repeat;\n        background-size: 200px 100px;\n        animation: sparkle 20s linear infinite;\n        z-index: -1;\n        opacity: 0.6;\n        pointer-events: none;\n      }\n\n      /* Efeito de partículas de fundo - Esmeralda */\n      body.chest-esmeralda::before {\n        content: \'\';\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: \n          radial-gradient(2px 2px at 20px 30px, rgba(144, 238, 144, 0.4), transparent),\n          radial-gradient(2px 2px at 40px 70px, rgba(50, 205, 50, 0.3), transparent),\n          radial-gradient(1px 1px at 90px 40px, rgba(34, 139, 34, 0.5), transparent),\n          radial-gradient(1px 1px at 130px 80px, rgba(144, 238, 144, 0.4), transparent),\n          radial-gradient(2px 2px at 160px 30px, rgba(50, 205, 50, 0.3), transparent);\n        background-repeat: repeat;\n        background-size: 200px 100px;\n        animation: sparkle 20s linear infinite;\n        z-index: -1;\n        opacity: 0.6;\n        pointer-events: none;\n      }\n\n\n      /* Efeito de brilho sutil - Clássico */\n      body.chest-classico::after {\n        content: \'\';\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: \n          radial-gradient(ellipse at center, rgba(255, 215, 0, 0.05) 0%, transparent 70%);\n        z-index: -1;\n        animation: glow 15s ease-in-out infinite alternate;\n        pointer-events: none;\n      }\n\n      /* Efeito de brilho sutil - Diamante */\n      body.chest-diamante::after {\n        content: \'\';\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: \n          radial-gradient(ellipse at center, rgba(135, 206, 250, 0.08) 0%, transparent 70%);\n        z-index: -1;\n        animation: glow 15s ease-in-out infinite alternate;\n        pointer-events: none;\n      }\n\n      /* Efeito de brilho sutil - Esmeralda */\n      body.chest-esmeralda::after {\n        content: \'\';\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: \n          radial-gradient(ellipse at center, rgba(144, 238, 144, 0.08) 0%, transparent 70%);\n        z-index: -1;\n        animation: glow 15s ease-in-out infinite alternate;\n        pointer-events: none;\n      }\n\n\n      @keyframes sparkle {\n        0% { transform: translateY(0) translateX(0); }\n        25% { transform: translateY(-10px) translateX(5px); }\n        50% { transform: translateY(-5px) translateX(-5px); }\n        75% { transform: translateY(-15px) translateX(10px); }\n        100% { transform: translateY(0) translateX(0); }\n      }\n\n      @keyframes glow {\n        0% { opacity: 0.3; }\n        100% { opacity: 0.7; }\n      }\n\n      .container {\n        text-align: center;\n        padding: 10px;\n        width: 100%;\n        max-width: 100%;\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        gap: 15px;\n      }\n\n      /* Sistema de Saldo */\n      .balance-system {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        background: rgba(255, 255, 255, 0.1);\n        border-radius: 12px;\n        padding: 15px 20px;\n        backdrop-filter: blur(10px);\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        margin-bottom: 20px;\n        width: 100%;\n        max-width: 400px;\n        order: 1;\n      }\n\n      .balance-display {\n        display: flex;\n    align-items: center;\n    gap: 8px;\n      }\n\n      .balance-label {\n        font-size: 1.1rem;\n        font-weight: bold;\n        color: #ffd700;\n        text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);\n      }\n\n      .balance-amount {\n        font-size: 1.3rem;\n        font-weight: bold;\n        color: #4CAF50;\n        text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);\n      }\n\n      .back-btn {\n        background: linear-gradient(45deg, #6c757d, #5a6268);\n        color: white;\n        box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);\n        font-size: 0.9rem;\n        padding: 8px 16px;\n        min-width: auto;\n        max-width: none;\n        flex: none;\n        border: none;\n        border-radius: 8px;\n        font-weight: bold;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        display: flex;\n        align-items: center;\n        gap: 6px;\n      }\n\n      .back-btn svg {\n        flex-shrink: 0;\n        transition: transform 0.3s ease;\n      }\n\n      .back-btn:hover:not(:disabled) {\n        transform: translateY(-2px);\n        box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);\n      }\n\n      .back-btn:hover:not(:disabled) svg {\n        transform: translateX(-2px);\n      }\n\n      /* Container do Baú */\n      .chest-container {\n        position: relative;\n        display: inline-block;\n        margin: 0;\n        order: 2;\n      }\n\n      .chest {\n        position: relative;\n        display: inline-block;\n        cursor: pointer;\n        transition: transform 0.3s ease;\n      }\n\n      .chest:hover {\n        transform: scale(1.05);\n      }\n\n      .chest-sprite {\n        width: clamp(200px, 50vw, 300px);\n        height: auto;\n        display: block;\n        transition: opacity 0.5s ease, transform 0.5s ease;\n        filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3));\n        border-radius: 6px;\n      }\n\n      /* Animações do baú */\n      .chest.closed .chest-sprite {\n        opacity: 1;\n        transform: scale(1);\n      }\n\n      .chest.opening .chest-sprite {\n        opacity: 0.7;\n        transform: scale(1.1);\n        animation: shake 0.3s ease-in-out;\n      }\n\n      .chest.open .chest-sprite {\n        opacity: 1;\n        transform: scale(1);\n      }\n\n      .chest.open-glow .chest-sprite {\n        opacity: 1;\n        transform: scale(1);\n        animation: glow 2s ease-in-out infinite alternate;\n      }\n\n      @keyframes shake {\n        0%, 100% { transform: scale(1.1) translateX(0); }\n        25% { transform: scale(1.1) translateX(-5px); }\n        75% { transform: scale(1.1) translateX(5px); }\n      }\n\n      @keyframes glow {\n        0% { \n          filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3)) \n                  drop-shadow(0 0 20px rgba(255, 215, 0, 0.5));\n        }\n        100% { \n          filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3)) \n                  drop-shadow(0 0 40px rgba(255, 215, 0, 0.8));\n        }\n      }\n\n      /* Container de Prêmio */\n      .prize-container {\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        z-index: 10;\n        opacity: 0;\n        pointer-events: none;\n      }\n\n      .prize {\n        position: relative;\n        display: inline-block;\n      }\n\n      .prize-image {\n        width: clamp(60px, 12vw, 100px);\n        height: auto;\n        display: block;\n        filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.5));\n        transition: all 0.5s ease;\n        border-radius: 6px;\n      }\n\n      .prize-value {\n        position: absolute;\n        bottom: -25px;\n        left: 50%;\n        transform: translateX(-50%);\n        background: linear-gradient(45deg, #4CAF50, #45a049);\n        color: white;\n        padding: 4px 12px;\n        border-radius: 15px;\n        font-size: 0.8rem;\n        font-weight: bold;\n        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);\n        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);\n        border: 2px solid rgba(255, 255, 255, 0.3);\n        white-space: nowrap;\n        z-index: 15;\n      }\n\n      .prize-glow {\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        width: clamp(100px, 18vw, 130px);\n        height: clamp(100px, 18vw, 130px);\n        background: radial-gradient(circle, rgba(255, 215, 0, 0.3) 0%, rgba(255, 215, 0, 0.1) 50%, transparent 70%);\n        border-radius: 50%;\n        pointer-events: none;\n        animation: prizeGlow 2s ease-in-out infinite alternate;\n      }\n\n      @keyframes prizeGlow {\n        0% { \n          opacity: 0.5;\n          transform: translate(-50%, -50%) scale(1);\n        }\n        100% { \n          opacity: 0.8;\n          transform: translate(-50%, -50%) scale(1.1);\n        }\n      }\n\n      .prize-container.show {\n        opacity: 1;\n        animation: showPrize 0.5s ease-out;\n      }\n\n      .prize-container.show .prize {\n        animation: prizeBounce 0.6s ease-out;\n      }\n\n      .prize-container.show .prize-image {\n        animation: prizeRotate 0.8s ease-out;\n      }\n\n      .prize-container.show .prize-glow {\n        animation: prizeGlow 2s ease-in-out infinite alternate;\n      }\n\n      @keyframes showPrize {\n        from { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }\n        to { opacity: 1; transform: translate(-50%, -50%) scale(1); }\n      }\n\n      @keyframes prizeBounce {\n        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }\n        40% { transform: translateY(-10px); }\n        60% { transform: translateY(-5px); }\n      }\n\n      @keyframes prizeRotate {\n        from { transform: rotate(0deg) scale(0.5); }\n        to { transform: rotate(360deg) scale(1); }\n      }\n\n      /* Seletor de Baús */\n      .chest-selector {\n        margin: 0;\n        padding: 10px;\n        background: rgba(255, 255, 255, 0.1);\n        border-radius: 8px;\n        backdrop-filter: blur(10px);\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        order: 3;\n        width: 100%;\n        max-width: 400px;\n      }\n\n      .chest-options {\n        display: flex;\n        gap: 10px;\n        justify-content: space-between;\n        flex-wrap: wrap;\n      }\n\n      .chest-option {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        padding: 8px;\n        background: rgba(255, 255, 255, 0.1);\n        border: 2px solid transparent;\n        border-radius: 6px;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        min-width: 80px;\n        flex: 1;\n        max-width: 100%;\n      }\n\n      .chest-option:hover {\n        background: rgba(255, 255, 255, 0.2);\n        transform: translateY(-2px);\n      }\n\n      .chest-option.active {\n        border-color: #ffd700;\n        background: rgba(255, 215, 0, 0.2);\n        box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);\n        transform: translateY(-3px);\n      }\n\n      .chest-option img {\n        width: 45px;\n        height: auto;\n        margin-bottom: 5px;\n        filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.3));\n      }\n\n      .chest-option span {\n        font-size: 0.8rem;\n        font-weight: bold;\n        color: white;\n        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);\n      }\n\n      .chest-cost {\n        font-size: 0.7rem !important;\n        color: #ffd700 !important;\n        font-weight: bold !important;\n        margin-top: 2px;\n        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7) !important;\n      }\n\n      /* Controles */\n      .controls {\n        margin: 0;\n        display: flex;\n        gap: 10px;\n        justify-content: space-between;\n        flex-wrap: wrap;\n        order: 4;\n        width: 100%;\n        max-width: 400px;\n      }\n\n      .btn {\n        padding: 10px 20px;\n        font-size: clamp(0.8rem, 3vw, 1rem);\n        font-weight: bold;\n        border: none;\n        border-radius: 8px;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        text-transform: uppercase;\n        letter-spacing: 1px;\n        flex: 1;\n        min-width: 100px;\n        max-width: 120px;\n      }\n\n      .btn:hover:not(:disabled) {\n        transform: translateY(-2px);\n        box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);\n      }\n\n      .btn:disabled {\n        opacity: 0.5;\n        cursor: not-allowed;\n        transform: none;\n      }\n\n      #openBtn {\n        background: linear-gradient(45deg, #4CAF50, #45a049);\n        color: white;\n        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);\n      }\n\n      #openBtn:hover:not(:disabled) {\n        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);\n      }\n\n      #closeBtn {\n        background: linear-gradient(45deg, #f44336, #da190b);\n        color: white;\n        box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);\n      }\n\n      #closeBtn:hover:not(:disabled) {\n        box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);\n      }\n\n      .info {\n        margin: 0;\n        font-size: clamp(0.8rem, 3vw, 1rem);\n        opacity: 0.8;\n        order: 5;\n        padding: 0 10px;\n      }\n\n      .lex-games-branding {\n        margin-top: 8px;\n        text-align: center;\n      }\n\n      .brand-text {\n        font-size: clamp(0.7rem, 2.5vw, 0.85rem);\n        color: #666;\n        margin: 0;\n        opacity: 0.7;\n        font-style: italic;\n      }\n\n      .brand-text strong {\n        color: #4a90e2;\n        font-weight: 600;\n      }\n\n      /* Partículas */\n      .particle {\n        position: absolute;\n        width: 4px;\n        height: 4px;\n        background: #ffd700;\n        border-radius: 50%;\n        pointer-events: none;\n        animation: particleFloat 2s ease-out forwards;\n      }\n\n      @keyframes particleFloat {\n        0% {\n          opacity: 1;\n          transform: translateY(0) scale(1);\n        }\n        100% {\n          opacity: 0;\n          transform: translateY(-100px) scale(0);\n        }\n      }\n\n      /* Responsividade Mobile */\n      @media (max-width: 768px) {\n        body {\n          padding: 5px;\n        }\n        \n        .container {\n          padding: 5px;\n          gap: 10px;\n        }\n        \n        .balance-system {\n          flex-direction: column;\n          gap: 10px;\n          padding: 12px 15px;\n        }\n        \n        .balance-display {\n          justify-content: center;\n        }\n        \n        .back-btn {\n          width: 100%;\n          max-width: 200px;\n        }\n        \n        .chest-selector {\n          padding: 10px;\n        }\n        \n        .chest-options {\n          gap: 8px;\n        }\n        \n        .chest-option {\n          min-width: 70px;\n          padding: 6px;\n        }\n        \n        .chest-option img {\n          width: 35px;\n        }\n        \n        .chest-option span {\n          font-size: 0.7rem;\n        }\n        \n        .controls {\n          gap: 8px;\n        }\n        \n        .btn {\n          padding: 8px 16px;\n        }\n      }\n\n      @media (max-width: 480px) {\n        .container {\n          gap: 8px;\n        }\n        \n        .chest-selector {\n          padding: 8px;\n        }\n        \n        .chest-options {\n          gap: 6px;\n        }\n        \n        .chest-option {\n          min-width: 60px;\n          padding: 4px;\n        }\n        \n        .chest-option img {\n          width: 30px;\n        }\n        \n        .chest-option span {\n          font-size: 0.6rem;\n        }\n        \n        .btn {\n          padding: 6px 12px;\n        }\n      }\n    </style>\n      <div class="widget-body">\n        <div class="container">\n          \x3c!-- Sistema de Saldo --\x3e\n          <div class="balance-system">\n            <div class="balance-display">\n              <span class="balance-label">Saldo:</span>\n              <span class="balance-amount" id="balanceAmount">R$ 1.000,00</span>\n            </div>\n            <button id="backBtn" class="back-btn">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                <path d="m12 19-7-7 7-7"/>\n                <path d="M19 12H5"/>\n              </svg>\n              Voltar\n            </button>\n          </div>\n          \n          <div class="chest-container">\n            <div class="chest closed" id="chest">\n              <img src="" alt="Baú Fechado" class="chest-sprite" id="chestSprite">\n            </div>\n            <div class="prize-container" id="prizeContainer">\n              <div class="prize" id="prize">\n                <img src="" alt="Prêmio" class="prize-image" id="prizeImage">\n                <div class="prize-value" id="prizeValue">+R$ 0,00</div>\n                <div class="prize-glow"></div>\n              </div>\n            </div>\n          </div>\n          \n          \x3c!-- Seletor de Baús --\x3e\n          <div class="chest-selector">\n            <div class="chest-options" id="chestOptions">\n              \x3c!-- Baús serão carregados dinamicamente aqui --\x3e\n            </div>\n          </div>\n\n          <div class="controls">\n            <button id="openBtn" class="btn">Abrir Baú</button>\n            <button id="closeBtn" class="btn" disabled>Fechar Baú</button>\n          </div>\n          \n          <div class="info">\n            \n            <div class="lex-games-branding">\n              <p class="brand-text">Desenvolvido por <strong>Lex Games</strong> © 2025</p>\n            </div>\n          </div>\n        </div>\n      </div>\n    '}validateElements(){this.chest=document.getElementById("chest"),this.chestSprite=document.getElementById("chestSprite"),this.prizeContainer=document.getElementById("prizeContainer"),this.prize=document.getElementById("prize"),this.prizeImage=document.getElementById("prizeImage"),this.prizeValue=document.getElementById("prizeValue"),this.openBtn=document.getElementById("openBtn"),this.closeBtn=document.getElementById("closeBtn"),this.balanceAmount=document.getElementById("balanceAmount"),this.backBtn=document.getElementById("backBtn");const e=["chest","chestSprite","prizeContainer","prize","prizeImage","prizeValue","openBtn","closeBtn","balanceAmount","backBtn"];for(const n of e)this[n]||console.error(`Elemento ${n} não encontrado no DOM`)}attachEventListeners(){this.openBtn.addEventListener("click",()=>this.openChest()),this.closeBtn.addEventListener("click",()=>this.closeChest()),this.backBtn.addEventListener("click",()=>this.goBack()),this.chest.addEventListener("click",()=>{"closed"===this.currentState?this.openChest():"open"!==this.currentState&&"openGlow"!==this.currentState||this.closeChest()})}async validateApiKey(){try{const e=await fetch(`${this.options.apiUrl}/api/chest/types`,{headers:{"X-API-Key":this.options.apiKey}});if(!e.ok)throw 401===e.status?new Error("API Key inválida. Verifique suas credenciais."):403===e.status?new Error("Acesso negado. API Key não tem permissão para acessar este recurso."):new Error(`Erro de validação da API: ${e.status}`);console.log("[Lex Games Widget] API Key validada com sucesso")}catch(e){if("TypeError"===e.name&&e.message.includes("fetch"))return void console.warn("[Lex Games Widget] API não disponível, usando modo demo");throw e}}updateBackground(e){document.body.classList.remove("chest-classico","chest-diamante","chest-esmeralda"),document.body.classList.add(`chest-${e}`)}startAutoCloseTimer(){this.autoCloseTimer&&clearTimeout(this.autoCloseTimer),console.log(`[Widget] Iniciando timer de fechamento automático em ${this.options.autoCloseDelay}ms`),this.autoCloseTimer=setTimeout(()=>{console.log("[Widget] Timer de fechamento automático executado"),this.closeChest()},this.options.autoCloseDelay)}clearAutoCloseTimer(){this.autoCloseTimer&&(console.log("[Widget] Limpando timer de fechamento automático"),clearTimeout(this.autoCloseTimer),this.autoCloseTimer=null)}async loadChestTypes(){try{const e=await fetch(`${this.options.apiUrl}/api/chest/types`,{headers:{"X-API-Key":this.options.apiKey}});if(!e.ok)throw new Error(`Erro ao carregar tipos de baús: ${e.status}`);const n=await e.json();this.chestTypes=n.data,this.updateChestOptions(),this.updateChestSprite()}catch(e){this.handleError("Erro ao carregar tipos de baús",e)}}updateChestOptions(){const e=document.getElementById("chestOptions");e&&(e.innerHTML="",this.chestTypes.forEach((n,t)=>{const a=document.createElement("button");a.className="chest-option "+(0===t?"active":""),a.dataset.chest=n.name;const i=n.images?n.images.closed:"baus/bau_fechado_classico.png";a.innerHTML=`\n        <img src="${i}" alt="${n.displayName}">\n        <span>${n.displayName.replace("Baú ","")}</span>\n        <span class="chest-cost">R$ ${parseFloat(n.cost).toFixed(2).replace(".",",")}</span>\n      `,a.addEventListener("click",()=>{this.selectChestType(n.name)}),e.appendChild(a)}),this.chestTypes.length>0&&(this.currentChestType=this.chestTypes[0].name))}selectChestType(e){document.querySelectorAll(".chest-option").forEach(e=>{e.classList.remove("active")});const n=document.querySelector(`[data-chest="${e}"]`);n&&n.classList.add("active"),this.currentChestType=e,this.updateChestSprite()}updateChestSprite(){if(!this.chestSprite)return;const e=this.chestTypes.find(e=>e.name===this.currentChestType),n=this.getChestVisualType(this.currentChestType);if(e&&e.images)this.chestSprite.src=e.images.closed;else{let e="baus/bau_fechado_classico.png";"diamante"===n?e="baus/bau_fechado_diamante.png":"esmeralda"===n&&(e="baus/bau_fechado_esmeralda.png"),this.chestSprite.src=this.getImageUrl(e)}document.body.className=`chest-${n}`}getChestVisualType(e){const n=this.chestTypes.find(n=>n.name===e);if(n&&n.visualType)return n.visualType;return{classico:"classico",diamante:"diamante",esmeralda:"esmeralda",premium:"classico",vip:"diamante"}[e]||"classico"}async loadBalance(){if(this.options.playerId){const e=this.player?this.player.balance:this.options.playerBalance;this.updateBalanceDisplay(parseFloat(e))}else this.updateBalanceDisplay(1e3)}updateBalanceDisplay(e){this.balanceAmount&&(this.balanceAmount.textContent=`R$ ${e.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`)}goBack(){window.parent&&window.parent!==window?window.parent.postMessage({action:"goBack"},"*"):window.location.href="/"}async openChest(){if(this.isAnimating||"closed"!==this.currentState)return;const e=this.options.playerId?this.player?parseFloat(this.player.balance):parseFloat(this.options.playerBalance):parseFloat(this.balanceAmount.textContent.replace("R$ ","").replace(".","").replace(",",".")),n=this.chestTypes.find(e=>e.name===this.currentChestType),t=n?parseFloat(n.cost):this.getDefaultChestCost();if(e<t)this.showNotification(`Saldo insuficiente! Necessário: R$ ${t.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`,"error");else{this.isAnimating=!0,this.updateButtons();try{this.options.playerId?await this.openChestWithAPI(t):await this.openChestDemo(t)}catch(e){console.error("Erro na animação:",e),this.showNotification("Erro ao abrir baú","error")}finally{this.isAnimating=!1,this.updateButtons()}}}async openChestWithAPI(e){this.chest.className="chest opening",this.soundEffects&&await this.soundEffects.playOpenSound(),await this.delay(300);const n=this.chestTypes.find(e=>e.name===this.currentChestType);if(n&&n.images)this.chestSprite.src=n.images.open;else{const e=this.getChestVisualType(this.currentChestType);this.chestSprite.src=this.getImageUrl(this.sprites[e].open)}if(this.chest.className="chest open",await this.delay(500),n&&n.images)this.chestSprite.src=n.images.openGlow;else{const e=this.getChestVisualType(this.currentChestType);this.chestSprite.src=this.getImageUrl(this.sprites[e].openGlow)}this.chest.className="chest open-glow",this.currentState="openGlow";const t=this.chestTypes.find(e=>e.name===this.currentChestType),a=await fetch(`${this.options.apiUrl}/api/chest/open`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.options.apiKey},body:JSON.stringify({playerId:this.options.playerId,playerBalance:this.player?this.player.balance:this.options.playerBalance,playerUsername:this.options.playerUsername,playerEmail:this.options.playerEmail,chestTypeId:t.id})});if(!a.ok){const e=await a.json().catch(()=>({}));throw new Error(`Erro ao abrir baú: ${a.status} - ${e.error||"Erro desconhecido"}`)}const i=await a.json();this.currentPrize=i.data.prize,this.player=i.data.player,this.options.playerBalance=parseFloat(this.player.balance),await this.showPrize(),this.createParticles(),this.updateBalanceDisplay(parseFloat(this.player.balance)),this.showNotification(`Você ganhou: ${this.currentPrize.name} (+R$ ${parseFloat(this.currentPrize.value).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})})`,"prize"),this.options.onChestOpened&&this.options.onChestOpened(i.data),this.options.onBalanceUpdate&&this.options.onBalanceUpdate(this.player.balance),await this.delay(2e3),this.chest.className="chest open-glow",this.startAutoCloseTimer()}async openChestDemo(e){const n=parseFloat(this.balanceAmount.textContent.replace("R$ ","").replace(".","").replace(",","."))-e;this.updateBalanceDisplay(n),this.chest.className="chest opening",this.soundEffects&&await this.soundEffects.playOpenSound(),await this.delay(300);const t=this.chestTypes.find(e=>e.name===this.currentChestType);t&&t.images?this.chestSprite.src=t.images.open:this.chestSprite.src=this.getImageUrl(this.sprites[this.currentChestType].open),this.chest.className="chest open",await this.delay(500),t&&t.images?this.chestSprite.src=t.images.openGlow:this.chestSprite.src=this.getImageUrl(this.sprites[this.currentChestType].openGlow),this.chest.className="chest open-glow",this.currentState="openGlow",this.currentPrize=this.getRandomPrize(this.currentChestType),await this.showPrize(),this.createParticles();const a=n+this.currentPrize.value;this.updateBalanceDisplay(a),this.showNotification(`Você ganhou: ${this.currentPrize.name} (+R$ ${this.currentPrize.value.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})})`,"prize"),await this.delay(2e3),this.chest.className="chest open-glow",this.startAutoCloseTimer()}async closeChest(){if(console.log(`[Widget] Tentando fechar baú - Estado: ${this.currentState}, Animando: ${this.isAnimating}`),this.isAnimating||"open"!==this.currentState&&"openGlow"!==this.currentState)console.log("[Widget] Fechamento cancelado - condições não atendidas");else{this.clearAutoCloseTimer(),this.isAnimating=!0,this.updateButtons();try{this.hidePrize(),await this.delay(300),this.chest.className="chest open";const e=this.chestTypes.find(e=>e.name===this.currentChestType);if(e&&e.images)this.chestSprite.src=e.images.open;else{const e=this.getChestVisualType(this.currentChestType);this.chestSprite.src=this.getImageUrl(this.sprites[e].open)}if(await this.delay(300),e&&e.images)this.chestSprite.src=e.images.closed;else{const e=this.getChestVisualType(this.currentChestType);this.chestSprite.src=this.getImageUrl(this.sprites[e].closed)}this.chest.className="chest closed",this.currentState="closed",this.soundEffects&&await this.soundEffects.playCloseSound()}catch(e){console.error("Erro ao fechar baú:",e)}finally{this.isAnimating=!1,this.updateButtons()}}}async showPrize(){this.prizeImage&&this.prizeValue&&this.currentPrize?(this.prizeImage.src=this.currentPrize.imageUrl||this.currentPrize.image,this.prizeValue.textContent=`+R$ ${this.currentPrize.value.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`,this.prizeContainer.classList.add("show"),this.soundEffects&&await this.soundEffects.playPrizeSound(),this.startAutoCloseTimer()):console.error("Elementos do prêmio não encontrados")}hidePrize(){this.prizeContainer.classList.remove("show"),this.currentPrize=null}createParticles(){if(!this.chest)return;const e=this.chest.getBoundingClientRect();for(let n=0;n<15;n++){const t=document.createElement("div"),a=2*Math.PI*n/15,i=50+30*Math.random(),s=e.left+e.width/2+Math.cos(a)*i,o=e.top+e.height/2+Math.sin(a)*i;t.style.position="fixed",t.style.left=s+"px",t.style.top=o+"px",t.style.width="4px",t.style.height="4px",t.style.background=`hsl(${45+30*Math.random()}, 100%, ${50+30*Math.random()}%)`,t.style.borderRadius="50%",t.style.pointerEvents="none",t.style.zIndex="9999",t.style.animation="particleFloat 2s ease-out forwards",t.style.animationDelay=.5*Math.random()+"s",document.body.appendChild(t),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},2e3)}}updateButtons(){"closed"===this.currentState?(this.openBtn.disabled=!1,this.closeBtn.disabled=!0):(this.openBtn.disabled=!0,this.closeBtn.disabled=!1)}getDefaultChestCost(){return{classico:50,diamante:150,esmeralda:500}[this.currentChestType]||50}getRandomPrize(e){const n={classico:[{name:"Moedas Pequenas",value:25,image:"premios/200.png"},{name:"Cristal Comum",value:30,image:"premios/687be92f11610.png"},{name:"Gema Azul",value:40,image:"premios/687be97e55304.png"},{name:"Pedra Preciosa",value:35,image:"premios/687be9cb1abad.png"},{name:"Cristal Brilhante",value:45,image:"premios/687bea587e903.png"}],diamante:[{name:"Diamante Pequeno",value:100,image:"premios/688e72599c346.png"},{name:"Cristal Diamante",value:150,image:"premios/689508b719535.png"},{name:"Gema Diamante",value:200,image:"premios/689508eaaae40.png"},{name:"Diamante Brilhante",value:250,image:"premios/689509043343a.png"},{name:"Cristal Épico",value:300,image:"premios/689509180004a.png"}],esmeralda:[{name:"Esmeralda Pequena",value:500,image:"premios/68a5513ec0a83.png"},{name:"Cristal Esmeralda",value:750,image:"premios/68a657fc213f9.png"},{name:"Gema Esmeralda",value:1e3,image:"premios/68a65899db3e2.png"},{name:"Esmeralda Brilhante",value:1250,image:"premios/68a66b4a6b45c.png"},{name:"Cristal Lendário",value:1500,image:"premios/68a66ce7959d3.png"}]},t=n[e]||n.classico,a=t[Math.floor(Math.random()*t.length)];return{...a,imageUrl:a.image}}async initializePlayer(){this.options.playerId&&await this.loginPlayer(this.options.playerId)}async loginPlayer(e){try{const n=await fetch(`${this.options.apiUrl}/api/auth/player/login`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.options.apiKey},body:JSON.stringify({externalId:e,username:`player_${e}`,email:`${e}@example.com`})});if(!n.ok)throw new Error(`Erro no login: ${n.status}`);const t=await n.json();this.player=t.data.player,this.playerToken=t.data.token,this.updateBalanceDisplay(parseFloat(this.player.balance)),this.options.onPlayerLogin&&this.options.onPlayerLogin(this.player),this.showNotification("Vamos abrir o baú!","success")}catch(e){this.handleError("Erro no login",e)}}showNotification(e,n="info"){const t=document.createElement("div");switch(t.className=`notification notification-${n}`,t.textContent=e,Object.assign(t.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",borderRadius:"8px",color:"white",fontWeight:"bold",zIndex:"1000",opacity:"0",transform:"translateX(100%)",transition:"all 0.3s ease",maxWidth:"300px",wordWrap:"break-word"}),n){case"success":t.style.background="linear-gradient(45deg, #4CAF50, #45a049)";break;case"error":t.style.background="linear-gradient(45deg, #f44336, #da190b)";break;case"prize":t.style.background="linear-gradient(45deg, #FF9800, #F57C00)";break;default:t.style.background="linear-gradient(45deg, #2196F3, #1976D2)"}document.body.appendChild(t),setTimeout(()=>{t.style.opacity="1",t.style.transform="translateX(0)"},100),setTimeout(()=>{t.style.opacity="0",t.style.transform="translateX(100%)",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},4e3)}delay(e){return new Promise(n=>setTimeout(n,e))}handleError(e,n){console.error(`[Baú da Sorte Widget] ${e}:`,n),this.container.querySelector(".widget-body")?this.showNotification(e,"error"):this.container.innerHTML=`\n        <div style="\n          display: flex;\n          flex-direction: column;\n          align-items: center;\n          justify-content: center;\n          min-height: 300px;\n          padding: 20px;\n          background: linear-gradient(135deg, #f44336, #da190b);\n          border-radius: 15px;\n          color: white;\n          text-align: center;\n          font-family: Arial, sans-serif;\n        ">\n          <h2 style="margin-bottom: 15px; font-size: 1.5rem;">🚫 Erro de Configuração</h2>\n          <p style="margin-bottom: 10px; font-size: 1.1rem;">${e}</p>\n          <p style="font-size: 0.9rem; opacity: 0.8;">Verifique sua API Key e tente novamente.</p>\n          <p style="font-size: 0.8rem; opacity: 0.6; margin-top: 15px; font-style: italic;">Desenvolvido por <strong>Lex Games</strong> © 2025</p>\n        </div>\n      `,this.options.onError&&this.options.onError(n)}destroy(){this.container&&(this.container.innerHTML="")}}class SoundEffects{constructor(){this.audioContext=null,this.init()}init(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(e){console.log("Web Audio API não suportada")}}async ensureAudioContext(){if(!this.audioContext)return!1;if("suspended"===this.audioContext.state)try{await this.audioContext.resume()}catch(e){return console.log("Erro ao ativar AudioContext:",e),!1}return!0}async playOpenSound(){if(!await this.ensureAudioContext())return;const e=this.audioContext.createOscillator(),n=this.audioContext.createGain();e.connect(n),n.connect(this.audioContext.destination),e.frequency.setValueAtTime(200,this.audioContext.currentTime),e.frequency.exponentialRampToValueAtTime(400,this.audioContext.currentTime+.3),n.gain.setValueAtTime(.1,this.audioContext.currentTime),n.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.3),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.3)}async playCloseSound(){if(!await this.ensureAudioContext())return;const e=this.audioContext.createOscillator(),n=this.audioContext.createGain();e.connect(n),n.connect(this.audioContext.destination),e.frequency.setValueAtTime(400,this.audioContext.currentTime),e.frequency.exponentialRampToValueAtTime(200,this.audioContext.currentTime+.2),n.gain.setValueAtTime(.1,this.audioContext.currentTime),n.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.2),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.2)}async playPrizeSound(){if(!await this.ensureAudioContext())return;[{freq:523.25,time:0,duration:.3},{freq:659.25,time:.1,duration:.3},{freq:783.99,time:.2,duration:.3},{freq:1046.5,time:.3,duration:.4},{freq:783.99,time:.5,duration:.2},{freq:1046.5,time:.6,duration:.5}].forEach(e=>{const n=this.audioContext.createOscillator(),t=this.audioContext.createGain();n.connect(t),t.connect(this.audioContext.destination),n.frequency.setValueAtTime(e.freq,this.audioContext.currentTime+e.time),n.frequency.setValueAtTime(1.02*e.freq,this.audioContext.currentTime+e.time+.5*e.duration),n.frequency.setValueAtTime(e.freq,this.audioContext.currentTime+e.time+e.duration),t.gain.setValueAtTime(0,this.audioContext.currentTime+e.time),t.gain.linearRampToValueAtTime(.15,this.audioContext.currentTime+e.time+.02),t.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+e.time+e.duration),n.start(this.audioContext.currentTime+e.time),n.stop(this.audioContext.currentTime+e.time+e.duration)}),setTimeout(()=>{[261.63,392,523.25].forEach((e,n)=>{const t=this.audioContext.createOscillator(),a=this.audioContext.createGain();t.connect(a),a.connect(this.audioContext.destination),t.frequency.setValueAtTime(e,this.audioContext.currentTime),t.frequency.exponentialRampToValueAtTime(1.2*e,this.audioContext.currentTime+.5),a.gain.setValueAtTime(0,this.audioContext.currentTime),a.gain.linearRampToValueAtTime(.08,this.audioContext.currentTime+.05),a.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.5),t.start(this.audioContext.currentTime),t.stop(this.audioContext.currentTime+.5)})},200),setTimeout(()=>{[1046.5,1318.51,1567.98].forEach((e,n)=>{const t=this.audioContext.createOscillator(),a=this.audioContext.createGain();t.connect(a),a.connect(this.audioContext.destination),t.frequency.setValueAtTime(e,this.audioContext.currentTime+.1*n),t.frequency.exponentialRampToValueAtTime(1.5*e,this.audioContext.currentTime+.1*n+.2),a.gain.setValueAtTime(0,this.audioContext.currentTime+.1*n),a.gain.linearRampToValueAtTime(.12,this.audioContext.currentTime+.1*n+.01),a.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.1*n+.2),t.start(this.audioContext.currentTime+.1*n),t.stop(this.audioContext.currentTime+.1*n+.2)})},800)}}"undefined"!=typeof window&&(window.BauDaSorteWidget=BauDaSorteWidget),"undefined"!=typeof module&&module.exports&&(module.exports=BauDaSorteWidget);