class BauDaSorteWidget{constructor(e={}){this.options={containerId:e.containerId||"bau-da-sorte-widget",apiUrl:e.apiUrl||"http://localhost:3000",apiKey:e.apiKey||"example-api-key-123",playerId:e.playerId||null,onPlayerLogin:e.onPlayerLogin||null,onChestOpened:e.onChestOpened||null,onBalanceUpdate:e.onBalanceUpdate||null,onError:e.onError||null,...e},this.player=null,this.playerToken=null,this.chestTypes=[],this.currentState="closed",this.isAnimating=!1,this.currentPrize=null,this.currentChestType="classico",this.chest=null,this.chestSprite=null,this.prizeContainer=null,this.prize=null,this.prizeImage=null,this.prizeValue=null,this.openBtn=null,this.closeBtn=null,this.resetBtn=null,this.balanceAmount=null,this.addBalanceBtn=null,this.sprites={classico:{closed:"baus/bau_fechado_classico.png",open:"baus/bau_aberto_classico.png",openGlow:"baus/bau_abereto_brilho_classico.png"},diamante:{closed:"baus/bau_fechado_diamante.png",open:"baus/bau_aberto_diamante.png",openGlow:"baus/bau_aberto_brilho_diamante.png"},esmeralda:{closed:"baus/bau_fechado_esmeralda.png",open:"baus/bau_aberto_esmeralda.png",openGlow:"baus/bau_aberto_brilho_esmeralda.png"}},this.soundEffects=new SoundEffects,this.init()}async init(){try{if(this.container=document.getElementById(this.options.containerId),!this.container)throw new Error(`Container com ID '${this.options.containerId}' n√£o encontrado`);await this.validateApiKey(),this.render(),this.validateElements(),this.attachEventListeners(),await this.loadChestTypes(),this.options.playerId&&await this.initializePlayer(),this.updateButtons()}catch(e){this.handleError("Erro ao inicializar widget",e)}}render(){this.container.innerHTML='\n      <style>\n      * {\n        margin: 0;\n        padding: 0;\n        box-sizing: border-box;\n      }\n\n      .widget-body {\n        font-family: \'Arial\', sans-serif;\n        min-height: 100vh;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        color: white;\n        padding: 10px;\n        box-sizing: border-box;\n        position: relative;\n        overflow-x: hidden;\n        transition: all 0.8s ease;\n        background: \n          radial-gradient(circle at 20% 20%, rgba(139, 69, 19, 0.3) 0%, transparent 50%),\n          radial-gradient(circle at 80% 80%, rgba(160, 82, 45, 0.2) 0%, transparent 50%),\n          radial-gradient(circle at 40% 60%, rgba(205, 133, 63, 0.1) 0%, transparent 50%),\n          linear-gradient(135deg, #2c1810 0%, #1a0f0a 50%, #0d0704 100%);\n      }\n\n      /* Background Cl√°ssico (padr√£o) */\n      .widget-body.chest-classico {\n        background: \n          radial-gradient(circle at 20% 20%, rgba(139, 69, 19, 0.3) 0%, transparent 50%),\n          radial-gradient(circle at 80% 80%, rgba(160, 82, 45, 0.2) 0%, transparent 50%),\n          radial-gradient(circle at 40% 60%, rgba(205, 133, 63, 0.1) 0%, transparent 50%),\n          linear-gradient(135deg, #2c1810 0%, #1a0f0a 50%, #0d0704 100%) !important;\n      }\n\n      /* Background Diamante */\n      .widget-body.chest-diamante {\n        background: \n          radial-gradient(circle at 20% 20%, rgba(70, 130, 180, 0.3) 0%, transparent 50%),\n          radial-gradient(circle at 80% 80%, rgba(100, 149, 237, 0.2) 0%, transparent 50%),\n          radial-gradient(circle at 40% 60%, rgba(135, 206, 250, 0.1) 0%, transparent 50%),\n          linear-gradient(135deg, #0f1419 0%, #0a0f14 50%, #05080a 100%) !important;\n      }\n\n      /* Background Esmeralda */\n      .widget-body.chest-esmeralda {\n        background: \n          radial-gradient(circle at 20% 20%, rgba(34, 139, 34, 0.3) 0%, transparent 50%),\n          radial-gradient(circle at 80% 80%, rgba(50, 205, 50, 0.2) 0%, transparent 50%),\n          radial-gradient(circle at 40% 60%, rgba(144, 238, 144, 0.1) 0%, transparent 50%),\n          linear-gradient(135deg, #0f1a0f 0%, #0a140a 50%, #050a05 100%) !important;\n      }\n\n      /* Efeito de part√≠culas de fundo - Cl√°ssico */\n      .widget-body.chest-classico::before {\n        content: \'\';\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: \n          radial-gradient(2px 2px at 20px 30px, rgba(255, 215, 0, 0.3), transparent),\n          radial-gradient(2px 2px at 40px 70px, rgba(255, 215, 0, 0.2), transparent),\n          radial-gradient(1px 1px at 90px 40px, rgba(255, 215, 0, 0.4), transparent),\n          radial-gradient(1px 1px at 130px 80px, rgba(255, 215, 0, 0.3), transparent),\n          radial-gradient(2px 2px at 160px 30px, rgba(255, 215, 0, 0.2), transparent);\n        background-repeat: repeat;\n        background-size: 200px 100px;\n        animation: sparkle 20s linear infinite;\n        z-index: -1;\n        opacity: 0.6;\n        pointer-events: none;\n      }\n\n      /* Efeito de part√≠culas de fundo - Diamante */\n      .widget-body.chest-diamante::before {\n        content: \'\';\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: \n          radial-gradient(2px 2px at 20px 30px, rgba(135, 206, 250, 0.4), transparent),\n          radial-gradient(2px 2px at 40px 70px, rgba(100, 149, 237, 0.3), transparent),\n          radial-gradient(1px 1px at 90px 40px, rgba(70, 130, 180, 0.5), transparent),\n          radial-gradient(1px 1px at 130px 80px, rgba(135, 206, 250, 0.4), transparent),\n          radial-gradient(2px 2px at 160px 30px, rgba(100, 149, 237, 0.3), transparent);\n        background-repeat: repeat;\n        background-size: 200px 100px;\n        animation: sparkle 20s linear infinite;\n        z-index: -1;\n        opacity: 0.6;\n        pointer-events: none;\n      }\n\n      /* Efeito de part√≠culas de fundo - Esmeralda */\n      .widget-body.chest-esmeralda::before {\n        content: \'\';\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: \n          radial-gradient(2px 2px at 20px 30px, rgba(144, 238, 144, 0.4), transparent),\n          radial-gradient(2px 2px at 40px 70px, rgba(50, 205, 50, 0.3), transparent),\n          radial-gradient(1px 1px at 90px 40px, rgba(34, 139, 34, 0.5), transparent),\n          radial-gradient(1px 1px at 130px 80px, rgba(144, 238, 144, 0.4), transparent),\n          radial-gradient(2px 2px at 160px 30px, rgba(50, 205, 50, 0.3), transparent);\n        background-repeat: repeat;\n        background-size: 200px 100px;\n        animation: sparkle 20s linear infinite;\n        z-index: -1;\n        opacity: 0.6;\n        pointer-events: none;\n      }\n\n      /* Efeito de brilho sutil - Cl√°ssico */\n      .widget-body.chest-classico::after {\n        content: \'\';\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: \n          radial-gradient(ellipse at center, rgba(255, 215, 0, 0.05) 0%, transparent 70%);\n        z-index: -1;\n        animation: glow 15s ease-in-out infinite alternate;\n        pointer-events: none;\n      }\n\n      /* Efeito de brilho sutil - Diamante */\n      .widget-body.chest-diamante::after {\n        content: \'\';\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: \n          radial-gradient(ellipse at center, rgba(135, 206, 250, 0.08) 0%, transparent 70%);\n        z-index: -1;\n        animation: glow 15s ease-in-out infinite alternate;\n        pointer-events: none;\n      }\n\n      /* Efeito de brilho sutil - Esmeralda */\n      .widget-body.chest-esmeralda::after {\n        content: \'\';\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: \n          radial-gradient(ellipse at center, rgba(144, 238, 144, 0.08) 0%, transparent 70%);\n        z-index: -1;\n        animation: glow 15s ease-in-out infinite alternate;\n        pointer-events: none;\n      }\n\n      @keyframes sparkle {\n        from { transform: translateX(0); }\n        to { transform: translateX(200px); }\n      }\n\n      @keyframes glow {\n        0% { opacity: 0.3; }\n        100% { opacity: 0.7; }\n      }\n\n      .container {\n        background: rgba(0, 0, 0, 0.3);\n        backdrop-filter: blur(15px);\n        border: 1px solid rgba(255, 255, 255, 0.1);\n        border-radius: 20px;\n        padding: 30px;\n        box-shadow: \n          0 20px 40px rgba(0, 0, 0, 0.4),\n          inset 0 1px 0 rgba(255, 255, 255, 0.1);\n        max-width: 600px;\n        width: 100%;\n        position: relative;\n        z-index: 1;\n      }\n\n      /* Sistema de Saldo */\n      .balance-system {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        background: rgba(255, 255, 255, 0.1);\n        border-radius: 12px;\n        padding: 15px 20px;\n        backdrop-filter: blur(10px);\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        margin-bottom: 20px;\n        width: 100%;\n        max-width: 400px;\n        order: 2;\n      }\n\n      .balance-display {\n        display: flex;\n    align-items: center;\n    gap: 8px;\n      }\n\n      .balance-label {\n        font-size: 1.1rem;\n        font-weight: bold;\n        color: #ffd700;\n        text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);\n      }\n\n      .balance-amount {\n        font-size: 1.3rem;\n        font-weight: bold;\n        color: #4CAF50;\n        text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);\n      }\n\n      .add-balance-btn {\n        background: linear-gradient(45deg, #4CAF50, #45a049);\n        color: white;\n        border: none;\n        padding: 12px 20px;\n        border-radius: 25px;\n        font-weight: bold;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        font-size: 1rem;\n        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);\n      }\n\n      .add-balance-btn:hover {\n        transform: translateY(-2px);\n        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);\n      }\n\n      /* Container do Ba√∫ */\n      .chest-container {\n        position: relative;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        min-height: 300px;\n        margin-bottom: 30px;\n      }\n\n      .chest {\n        position: relative;\n        cursor: pointer;\n        transition: transform 0.3s ease;\n      }\n\n      .chest:hover {\n        transform: scale(1.02);\n      }\n\n      .chest-sprite {\n        width: 200px;\n        height: 200px;\n        object-fit: contain;\n        filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3));\n        transition: all 0.3s ease;\n      }\n\n      /* Anima√ß√µes do ba√∫ */\n      .chest.closed .chest-sprite {\n        opacity: 1;\n        transform: scale(1);\n      }\n\n      .chest.opening .chest-sprite {\n        opacity: 0.7;\n        transform: scale(1.1);\n        animation: shake 0.3s ease-in-out;\n      }\n\n      .chest.open .chest-sprite {\n        opacity: 1;\n        transform: scale(1);\n      }\n\n      .chest.open-glow .chest-sprite {\n        opacity: 1;\n        transform: scale(1);\n        animation: glow 2s ease-in-out infinite alternate;\n      }\n\n      @keyframes shake {\n        0%, 100% { transform: scale(1.1) translateX(0); }\n        25% { transform: scale(1.1) translateX(-5px); }\n        75% { transform: scale(1.1) translateX(5px); }\n      }\n\n      @keyframes glow {\n        0% { \n          filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3)) \n                  drop-shadow(0 0 20px rgba(255, 215, 0, 0.5));\n        }\n        100% { \n          filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3)) \n                  drop-shadow(0 0 40px rgba(255, 215, 0, 0.8));\n        }\n      }\n\n      /* Container de Pr√™mio */\n      .prize-container {\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        z-index: 10;\n        opacity: 0;\n        pointer-events: none;\n      }\n\n      .prize {\n        position: relative;\n        display: inline-block;\n      }\n\n      .prize-image {\n        width: clamp(60px, 12vw, 100px);\n        height: auto;\n        display: block;\n        filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.5));\n        transition: all 0.5s ease;\n        border-radius: 6px;\n      }\n\n      .prize-value {\n        position: absolute;\n        bottom: -25px;\n        left: 50%;\n        transform: translateX(-50%);\n        background: linear-gradient(45deg, #4CAF50, #45a049);\n        color: white;\n        padding: 4px 12px;\n        border-radius: 15px;\n        font-size: 0.8rem;\n        font-weight: bold;\n        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);\n        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);\n        border: 2px solid rgba(255, 255, 255, 0.3);\n        white-space: nowrap;\n        z-index: 15;\n      }\n\n      .prize-glow {\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        width: clamp(100px, 18vw, 130px);\n        height: clamp(100px, 18vw, 130px);\n        background: radial-gradient(circle, rgba(255, 215, 0, 0.3) 0%, rgba(255, 215, 0, 0.1) 50%, transparent 70%);\n        border-radius: 50%;\n        pointer-events: none;\n        animation: prizeGlow 2s ease-in-out infinite alternate;\n      }\n\n      @keyframes prizeGlow {\n        0% { \n          opacity: 0.5;\n          transform: translate(-50%, -50%) scale(1);\n        }\n        100% { \n          opacity: 0.8;\n          transform: translate(-50%, -50%) scale(1.1);\n        }\n      }\n\n      .prize-container.show {\n        opacity: 1;\n        animation: showPrize 0.5s ease-out;\n      }\n\n      .prize-container.show .prize {\n        animation: prizeBounce 0.6s ease-out;\n      }\n\n      .prize-container.show .prize-image {\n        animation: prizeRotate 0.8s ease-out;\n      }\n\n      .prize-container.show .prize-glow {\n        animation: prizeGlow 2s ease-in-out infinite alternate;\n      }\n\n      @keyframes showPrize {\n        from { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }\n        to { opacity: 1; transform: translate(-50%, -50%) scale(1); }\n      }\n\n      @keyframes prizeBounce {\n        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }\n        40% { transform: translateY(-10px); }\n        60% { transform: translateY(-5px); }\n      }\n\n      @keyframes prizeRotate {\n        from { transform: rotate(0deg) scale(0.5); }\n        to { transform: rotate(360deg) scale(1); }\n      }\n\n      /* Seletor de Ba√∫s */\n      .chest-selector {\n        margin-bottom: 30px;\n      }\n\n      .chest-options {\n        display: flex;\n        gap: 20px;\n        justify-content: center;\n        flex-wrap: wrap;\n      }\n\n      .chest-option {\n        background: rgba(255, 255, 255, 0.05);\n        border: 2px solid rgba(255, 255, 255, 0.1);\n        border-radius: 15px;\n        padding: 15px;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        gap: 8px;\n        min-width: 120px;\n        backdrop-filter: blur(10px);\n      }\n\n      .chest-option:hover {\n        background: rgba(255, 255, 255, 0.1);\n        transform: translateY(-3px);\n        box-shadow: 0 5px 20px rgba(255, 255, 255, 0.1);\n      }\n\n      .chest-option.active {\n        border-color: #ffd700;\n        background: rgba(255, 215, 0, 0.15);\n        box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);\n        transform: translateY(-3px);\n      }\n\n      .chest-option img {\n        width: 80px;\n        height: 80px;\n        object-fit: contain;\n        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));\n      }\n\n      .chest-option span {\n        font-size: 1rem;\n        font-weight: bold;\n        color: white;\n        text-align: center;\n      }\n\n      .chest-cost {\n        color: #4CAF50 !important;\n        font-size: 0.9rem !important;\n        font-weight: bold;\n      }\n\n      /* Controles */\n      .controls {\n        display: flex;\n        gap: 15px;\n        justify-content: center;\n        margin-bottom: 20px;\n        flex-wrap: wrap;\n      }\n\n      .btn {\n        background: linear-gradient(45deg, #2196F3, #1976D2);\n        color: white;\n        border: none;\n        padding: 15px 30px;\n        border-radius: 25px;\n        font-weight: bold;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        font-size: 1rem;\n        min-width: 120px;\n        box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);\n      }\n\n      .btn:hover:not(:disabled) {\n        transform: translateY(-2px);\n        box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);\n      }\n\n      .btn:disabled {\n        opacity: 0.5;\n        cursor: not-allowed;\n        transform: none;\n      }\n\n      #openBtn {\n        background: linear-gradient(45deg, #4CAF50, #45a049);\n        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);\n      }\n\n      #openBtn:hover:not(:disabled) {\n        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);\n      }\n\n      #closeBtn {\n        background: linear-gradient(45deg, #f44336, #da190b);\n        box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);\n      }\n\n      #closeBtn:hover:not(:disabled) {\n        box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);\n      }\n\n      .info {\n        text-align: center;\n        color: rgba(255, 255, 255, 0.7);\n        font-size: 1rem;\n      }\n\n      /* Part√≠culas */\n      .particle {\n        position: absolute;\n        width: 4px;\n        height: 4px;\n        background: #ffd700;\n        border-radius: 50%;\n        pointer-events: none;\n        animation: particleFloat 2s ease-out forwards;\n      }\n\n      @keyframes particleFloat {\n        0% {\n          opacity: 1;\n          transform: translateY(0) scale(1);\n        }\n        100% {\n          opacity: 0;\n          transform: translateY(-100px) scale(0);\n        }\n      }\n\n      /* Responsivo */\n      @media (max-width: 768px) {\n        .container {\n          padding: 20px;\n          margin: 10px;\n        }\n\n        .chest-sprite {\n          width: 150px;\n          height: 150px;\n        }\n\n        .chest-options {\n          gap: 10px;\n        }\n\n        .chest-option {\n          min-width: 100px;\n          padding: 10px;\n        }\n\n        .chest-option img {\n          width: 60px;\n          height: 60px;\n        }\n\n        .controls {\n          flex-direction: column;\n          align-items: center;\n        }\n\n        .btn {\n          width: 200px;\n        }\n      }\n    </style>\n      <div class="widget-body">\n        <div class="container">\n          \x3c!-- Sistema de Saldo --\x3e\n          <div class="balance-system">\n            <div class="balance-display">\n              <span class="balance-label">Saldo:</span>\n              <span class="balance-amount" id="balanceAmount">R$ 1.000,00</span>\n            </div>\n            <button id="addBalanceBtn" class="add-balance-btn">+ R$ 500,00</button>\n          </div>\n          \n          <div class="chest-container">\n            <div class="chest closed" id="chest">\n              <img src="baus/bau_fechado_classico.png" alt="Ba√∫ Fechado" class="chest-sprite" id="chestSprite">\n            </div>\n            <div class="prize-container" id="prizeContainer">\n              <div class="prize" id="prize">\n                <img src="" alt="Pr√™mio" class="prize-image" id="prizeImage">\n                <div class="prize-value" id="prizeValue">+R$ 0,00</div>\n                <div class="prize-glow"></div>\n              </div>\n            </div>\n          </div>\n          \n          \x3c!-- Seletor de Ba√∫s --\x3e\n          <div class="chest-selector">\n            <div class="chest-options">\n              <button class="chest-option active" data-chest="classico">\n                <img src="baus/bau_fechado_classico.png" alt="Ba√∫ Cl√°ssico">\n                <span>Cl√°ssico</span>\n                <span class="chest-cost">R$ 50,00</span>\n              </button>\n              <button class="chest-option" data-chest="diamante">\n                <img src="baus/bau_fechado_diamante.png" alt="Ba√∫ Diamante">\n                <span>Diamante</span>\n                <span class="chest-cost">R$ 150,00</span>\n              </button>\n              <button class="chest-option" data-chest="esmeralda">\n                <img src="baus/bau_fechado_esmeralda.png" alt="Ba√∫ Esmeralda">\n                <span>Esmeralda</span>\n                <span class="chest-cost">R$ 500,00</span>\n              </button>\n            </div>\n          </div>\n\n          <div class="controls">\n            <button id="openBtn" class="btn">Abrir Ba√∫</button>\n            <button id="closeBtn" class="btn" disabled>Fechar Ba√∫</button>\n            <button id="resetBtn" class="btn">Reset</button>\n          </div>\n          \n          <div class="info">\n            <p>Clique em "Abrir Ba√∫" para ver a anima√ß√£o de abertura!</p>\n          </div>\n        </div>\n      </div>\n    '}validateElements(){this.chest=document.getElementById("chest"),this.chestSprite=document.getElementById("chestSprite"),this.prizeContainer=document.getElementById("prizeContainer"),this.prize=document.getElementById("prize"),this.prizeImage=document.getElementById("prizeImage"),this.prizeValue=document.getElementById("prizeValue"),this.openBtn=document.getElementById("openBtn"),this.closeBtn=document.getElementById("closeBtn"),this.resetBtn=document.getElementById("resetBtn"),this.balanceAmount=document.getElementById("balanceAmount"),this.addBalanceBtn=document.getElementById("addBalanceBtn");const e=["chest","chestSprite","prizeContainer","prize","prizeImage","prizeValue","openBtn","closeBtn","resetBtn","balanceAmount","addBalanceBtn"];for(const t of e)this[t]||console.error(`Elemento ${t} n√£o encontrado no DOM`)}attachEventListeners(){this.openBtn.addEventListener("click",()=>this.openChest()),this.closeBtn.addEventListener("click",()=>this.closeChest()),this.resetBtn.addEventListener("click",()=>this.resetChest()),this.addBalanceBtn.addEventListener("click",()=>this.addBalance()),this.chest.addEventListener("click",()=>{"closed"===this.currentState?this.openChest():"open"!==this.currentState&&"openGlow"!==this.currentState||this.closeChest()}),this.initChestSelector()}initChestSelector(){document.querySelectorAll(".chest-option").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".chest-option").forEach(e=>e.classList.remove("active")),e.classList.add("active"),this.currentChestType=e.dataset.chest,this.chestSprite.src=this.sprites[this.currentChestType].closed,this.updateBackground(this.currentChestType),this.updateButtons()})})}async validateApiKey(){try{const e=await fetch(`${this.options.apiUrl}/api/chest/types`,{headers:{"X-API-Key":this.options.apiKey}});if(!e.ok)throw 401===e.status?new Error("API Key inv√°lida. Verifique suas credenciais."):403===e.status?new Error("Acesso negado. API Key n√£o tem permiss√£o para acessar este recurso."):new Error(`Erro de valida√ß√£o da API: ${e.status}`);console.log("[Widget] API Key validada com sucesso")}catch(e){if("TypeError"===e.name&&e.message.includes("fetch"))return void console.warn("[Widget] API n√£o dispon√≠vel, usando modo demo");throw e}}updateBackground(e){const t=document.querySelector(".widget-body");t&&(t.classList.remove("chest-classico","chest-diamante","chest-esmeralda"),t.classList.add(`chest-${e}`))}async loadChestTypes(){try{const e=await fetch(`${this.options.apiUrl}/api/chest/types`,{headers:{"X-API-Key":this.options.apiKey}});if(!e.ok)throw new Error(`Erro ao carregar tipos de ba√∫s: ${e.status}`);const t=await e.json();this.chestTypes=t.data,this.updateChestOptions()}catch(e){this.handleError("Erro ao carregar tipos de ba√∫s",e)}}updateChestOptions(){document.querySelectorAll(".chest-option").forEach(e=>{const t=e.dataset.chest,n=this.chestTypes.find(e=>e.name===t);if(n){e.querySelector(".chest-cost").textContent=`R$ ${parseFloat(n.cost).toFixed(2).replace(".",",")}`}})}async loadBalance(){this.player?this.updateBalanceDisplay(parseFloat(this.player.balance)):this.updateBalanceDisplay(1e3)}updateBalanceDisplay(e){this.balanceAmount&&(this.balanceAmount.textContent=`R$ ${e.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`)}async addBalance(){if(this.isAnimating)return;if(this.player)return void this.showNotification("Para adicionar saldo, entre em contato com o suporte","error");const e=parseFloat(this.balanceAmount.textContent.replace("R$ ","").replace(".","").replace(",","."))+500;this.updateBalanceDisplay(e),this.showNotification("Saldo adicionado: +R$ 500,00","success")}async openChest(){if(this.isAnimating||"closed"!==this.currentState)return;const e=this.player?parseFloat(this.player.balance):parseFloat(this.balanceAmount.textContent.replace("R$ ","").replace(".","").replace(",",".")),t=this.chestTypes.find(e=>e.name===this.currentChestType),n=t?parseFloat(t.cost):this.getDefaultChestCost();if(e<n)this.showNotification(`Saldo insuficiente! Necess√°rio: R$ ${n.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`,"error");else{this.isAnimating=!0,this.updateButtons();try{this.player?await this.openChestWithAPI(n):await this.openChestDemo(n)}catch(e){console.error("Erro na anima√ß√£o:",e),this.showNotification("Erro ao abrir ba√∫","error")}finally{this.isAnimating=!1,this.updateButtons()}}}async openChestWithAPI(e){const t=parseFloat(this.player.balance)-e;this.player.balance=t,this.updateBalanceDisplay(t),this.chest.className="chest opening",this.soundEffects&&await this.soundEffects.playOpenSound(),await this.delay(300),this.chestSprite.src=this.sprites[this.currentChestType].open,this.chest.className="chest open",await this.delay(500),this.chestSprite.src=this.sprites[this.currentChestType].openGlow,this.chest.className="chest open-glow",this.currentState="openGlow";const n=this.chestTypes.find(e=>e.name===this.currentChestType),a=await fetch(`${this.options.apiUrl}/api/chest/open`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.options.apiKey,Authorization:`Bearer ${this.playerToken}`},body:JSON.stringify({playerId:this.player.id,chestTypeId:n.id})});if(!a.ok)throw new Error(`Erro ao abrir ba√∫: ${a.status}`);const i=await a.json();this.currentPrize=i.data.prize,this.player=i.data.player,await this.showPrize(),this.createParticles(),this.updateBalanceDisplay(parseFloat(this.player.balance)),this.showNotification(`Voc√™ ganhou: ${this.currentPrize.name} (+R$ ${parseFloat(this.currentPrize.value).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})})`,"prize"),this.options.onChestOpened&&this.options.onChestOpened(i.data),this.options.onBalanceUpdate&&this.options.onBalanceUpdate(this.player.balance),await this.delay(2e3),this.chest.className="chest open-glow"}async openChestDemo(e){const t=parseFloat(this.balanceAmount.textContent.replace("R$ ","").replace(".","").replace(",","."))-e;this.updateBalanceDisplay(t),this.chest.className="chest opening",this.soundEffects&&await this.soundEffects.playOpenSound(),await this.delay(300),this.chestSprite.src=this.sprites[this.currentChestType].open,this.chest.className="chest open",await this.delay(500),this.chestSprite.src=this.sprites[this.currentChestType].openGlow,this.chest.className="chest open-glow",this.currentState="openGlow",this.currentPrize=this.getRandomPrize(this.currentChestType),await this.showPrize(),this.createParticles();const n=t+this.currentPrize.value;this.updateBalanceDisplay(n),this.showNotification(`Voc√™ ganhou: ${this.currentPrize.name} (+R$ ${this.currentPrize.value.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})})`,"prize"),await this.delay(2e3),this.chest.className="chest open-glow"}async closeChest(){if(!(this.isAnimating||"open"!==this.currentState&&"openGlow"!==this.currentState)){this.isAnimating=!0,this.updateButtons();try{this.hidePrize(),await this.delay(300),this.chest.className="chest open",this.chestSprite.src=this.sprites[this.currentChestType].open,await this.delay(300),this.chestSprite.src=this.sprites[this.currentChestType].closed,this.chest.className="chest closed",this.currentState="closed",this.soundEffects&&await this.soundEffects.playCloseSound()}catch(e){console.error("Erro ao fechar ba√∫:",e)}finally{this.isAnimating=!1,this.updateButtons()}}}resetChest(){this.isAnimating||(this.chestSprite.src=this.sprites[this.currentChestType].closed,this.chest.className="chest closed",this.currentState="closed",this.hidePrize(),this.updateButtons())}async showPrize(){this.prizeImage&&this.prizeValue&&this.currentPrize?(this.prizeImage.src=this.currentPrize.imageUrl||this.currentPrize.image,this.prizeValue.textContent=`+R$ ${this.currentPrize.value.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`,this.prizeContainer.classList.add("show"),this.soundEffects&&await this.soundEffects.playPrizeSound()):console.error("Elementos do pr√™mio n√£o encontrados")}hidePrize(){this.prizeContainer.classList.remove("show"),this.currentPrize=null}createParticles(){if(!this.chest)return;const e=this.chest.getBoundingClientRect();for(let t=0;t<15;t++){const n=document.createElement("div"),a=2*Math.PI*t/15,i=50+30*Math.random(),s=e.left+e.width/2+Math.cos(a)*i,r=e.top+e.height/2+Math.sin(a)*i;n.style.position="fixed",n.style.left=s+"px",n.style.top=r+"px",n.style.width="4px",n.style.height="4px",n.style.background=`hsl(${45+30*Math.random()}, 100%, ${50+30*Math.random()}%)`,n.style.borderRadius="50%",n.style.pointerEvents="none",n.style.zIndex="9999",n.style.animation="particleFloat 2s ease-out forwards",n.style.animationDelay=.5*Math.random()+"s",document.body.appendChild(n),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},2e3)}}updateButtons(){"closed"===this.currentState?(this.openBtn.disabled=!1,this.closeBtn.disabled=!0):(this.openBtn.disabled=!0,this.closeBtn.disabled=!1)}getDefaultChestCost(){return{classico:50,diamante:150,esmeralda:500}[this.currentChestType]||50}getRandomPrize(e){const t={classico:[{name:"Moedas Pequenas",value:25,image:"premios/200.png"},{name:"Cristal Comum",value:30,image:"premios/687be92f11610.png"},{name:"Gema Azul",value:40,image:"premios/687be97e55304.png"},{name:"Pedra Preciosa",value:35,image:"premios/687be9cb1abad.png"},{name:"Cristal Brilhante",value:45,image:"premios/687bea587e903.png"}],diamante:[{name:"Diamante Pequeno",value:100,image:"premios/688e72599c346.png"},{name:"Cristal Diamante",value:150,image:"premios/689508b719535.png"},{name:"Gema Diamante",value:200,image:"premios/689508eaaae40.png"},{name:"Diamante Brilhante",value:250,image:"premios/689509043343a.png"},{name:"Cristal √âpico",value:300,image:"premios/689509180004a.png"}],esmeralda:[{name:"Esmeralda Pequena",value:500,image:"premios/68a5513ec0a83.png"},{name:"Cristal Esmeralda",value:750,image:"premios/68a657fc213f9.png"},{name:"Gema Esmeralda",value:1e3,image:"premios/68a65899db3e2.png"},{name:"Esmeralda Brilhante",value:1250,image:"premios/68a66b4a6b45c.png"},{name:"Cristal Lend√°rio",value:1500,image:"premios/68a66ce7959d3.png"}]},n=t[e]||t.classico,a=n[Math.floor(Math.random()*n.length)];return{...a,imageUrl:a.image}}async initializePlayer(){this.options.playerId&&await this.loginPlayer(this.options.playerId)}async loginPlayer(e){try{const t=await fetch(`${this.options.apiUrl}/api/auth/player/login`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.options.apiKey},body:JSON.stringify({externalId:e,username:`player_${e}`,email:`${e}@example.com`})});if(!t.ok)throw new Error(`Erro no login: ${t.status}`);const n=await t.json();this.player=n.data.player,this.playerToken=n.data.token,this.updateBalanceDisplay(parseFloat(this.player.balance)),this.options.onPlayerLogin&&this.options.onPlayerLogin(this.player),this.showNotification("Login realizado com sucesso!","success")}catch(e){this.handleError("Erro no login",e)}}showNotification(e,t="info"){const n=document.createElement("div");switch(n.className=`notification notification-${t}`,n.textContent=e,Object.assign(n.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",borderRadius:"8px",color:"white",fontWeight:"bold",zIndex:"1000",opacity:"0",transform:"translateX(100%)",transition:"all 0.3s ease",maxWidth:"300px",wordWrap:"break-word"}),t){case"success":n.style.background="linear-gradient(45deg, #4CAF50, #45a049)";break;case"error":n.style.background="linear-gradient(45deg, #f44336, #da190b)";break;case"prize":n.style.background="linear-gradient(45deg, #FF9800, #F57C00)";break;default:n.style.background="linear-gradient(45deg, #2196F3, #1976D2)"}document.body.appendChild(n),setTimeout(()=>{n.style.opacity="1",n.style.transform="translateX(0)"},100),setTimeout(()=>{n.style.opacity="0",n.style.transform="translateX(100%)",setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},300)},4e3)}delay(e){return new Promise(t=>setTimeout(t,e))}handleError(e,t){console.error(`[Ba√∫ da Sorte Widget] ${e}:`,t),this.container.querySelector(".widget-body")?this.showNotification(e,"error"):this.container.innerHTML=`\n        <div style="\n          display: flex;\n          flex-direction: column;\n          align-items: center;\n          justify-content: center;\n          min-height: 300px;\n          padding: 20px;\n          background: linear-gradient(135deg, #f44336, #da190b);\n          border-radius: 15px;\n          color: white;\n          text-align: center;\n          font-family: Arial, sans-serif;\n        ">\n          <h2 style="margin-bottom: 15px; font-size: 1.5rem;">üö´ Erro de Configura√ß√£o</h2>\n          <p style="margin-bottom: 10px; font-size: 1.1rem;">${e}</p>\n          <p style="font-size: 0.9rem; opacity: 0.8;">Verifique sua API Key e tente novamente.</p>\n        </div>\n      `,this.options.onError&&this.options.onError(t)}destroy(){this.container&&(this.container.innerHTML="")}}class SoundEffects{constructor(){this.audioContext=null,this.init()}init(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(e){console.log("Web Audio API n√£o suportada")}}async ensureAudioContext(){if(!this.audioContext)return!1;if("suspended"===this.audioContext.state)try{await this.audioContext.resume()}catch(e){return console.log("Erro ao ativar AudioContext:",e),!1}return!0}async playOpenSound(){if(!await this.ensureAudioContext())return;const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.frequency.setValueAtTime(200,this.audioContext.currentTime),e.frequency.exponentialRampToValueAtTime(400,this.audioContext.currentTime+.3),t.gain.setValueAtTime(.1,this.audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.3),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.3)}async playCloseSound(){if(!await this.ensureAudioContext())return;const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.frequency.setValueAtTime(400,this.audioContext.currentTime),e.frequency.exponentialRampToValueAtTime(200,this.audioContext.currentTime+.2),t.gain.setValueAtTime(.1,this.audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.2),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.2)}async playPrizeSound(){if(!await this.ensureAudioContext())return;[{freq:523.25,time:0,duration:.3},{freq:659.25,time:.1,duration:.3},{freq:783.99,time:.2,duration:.3},{freq:1046.5,time:.3,duration:.4},{freq:783.99,time:.5,duration:.2},{freq:1046.5,time:.6,duration:.5}].forEach(e=>{const t=this.audioContext.createOscillator(),n=this.audioContext.createGain();t.connect(n),n.connect(this.audioContext.destination),t.frequency.setValueAtTime(e.freq,this.audioContext.currentTime+e.time),t.frequency.setValueAtTime(1.02*e.freq,this.audioContext.currentTime+e.time+.5*e.duration),t.frequency.setValueAtTime(e.freq,this.audioContext.currentTime+e.time+e.duration),n.gain.setValueAtTime(0,this.audioContext.currentTime+e.time),n.gain.linearRampToValueAtTime(.15,this.audioContext.currentTime+e.time+.02),n.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+e.time+e.duration),t.start(this.audioContext.currentTime+e.time),t.stop(this.audioContext.currentTime+e.time+e.duration)}),setTimeout(()=>{[261.63,392,523.25].forEach((e,t)=>{const n=this.audioContext.createOscillator(),a=this.audioContext.createGain();n.connect(a),a.connect(this.audioContext.destination),n.frequency.setValueAtTime(e,this.audioContext.currentTime),n.frequency.exponentialRampToValueAtTime(1.2*e,this.audioContext.currentTime+.5),a.gain.setValueAtTime(0,this.audioContext.currentTime),a.gain.linearRampToValueAtTime(.08,this.audioContext.currentTime+.05),a.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.5),n.start(this.audioContext.currentTime),n.stop(this.audioContext.currentTime+.5)})},200),setTimeout(()=>{[1046.5,1318.51,1567.98].forEach((e,t)=>{const n=this.audioContext.createOscillator(),a=this.audioContext.createGain();n.connect(a),a.connect(this.audioContext.destination),n.frequency.setValueAtTime(e,this.audioContext.currentTime+.1*t),n.frequency.exponentialRampToValueAtTime(1.5*e,this.audioContext.currentTime+.1*t+.2),a.gain.setValueAtTime(0,this.audioContext.currentTime+.1*t),a.gain.linearRampToValueAtTime(.12,this.audioContext.currentTime+.1*t+.01),a.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.1*t+.2),n.start(this.audioContext.currentTime+.1*t),n.stop(this.audioContext.currentTime+.1*t+.2)})},800)}}"undefined"!=typeof window&&(window.BauDaSorteWidget=BauDaSorteWidget),"undefined"!=typeof module&&module.exports&&(module.exports=BauDaSorteWidget);